<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Versus Revise - Absolute Reverse Auditor (Shin-Hanabi DNA)</title>
    <style>
        :root { --c-bg: #111; --c-text: #eee; --c-accent: #ffd700; }
        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; }
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; background: var(--c-bg); color: var(--c-text); font-family: "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif; overflow: hidden; display: flex; flex-direction: column; }
        .controls { padding: 5px; flex-shrink: 0; background: #222; border-bottom: 1px solid #444; }
        .tab-group { display: flex; gap: 4px; margin-bottom: 5px; overflow-x: auto; }
        .tab { flex: 1; padding: 8px 4px; text-align: center; font-size: 11px; font-weight: bold; cursor: pointer; border-radius: 4px; border: 1px solid #444; opacity: 0.5; transition: all 0.2s; white-space: nowrap; min-width: 60px; }
        .tab.active { opacity: 1; border-color: #888; box-shadow: 0 0 5px rgba(255,255,255,0.2); }
        .stop-tab.active#t-left { background: #ffb7ce; color: #800020; }
        .stop-tab.active#t-middle { background: #b3e5fc; color: #003c8f; }
        .stop-tab.active#t-right { background: #c8e6c9; color: #1b5e20; }
        .state-tab#s-bonus_unestablished.active { background: #fff; color: #000; }
        .state-tab#s-don_big_established.active { background: #304ffe; color: #fff; }
        .state-tab#s-seven_big_established.active { background: #d50000; color: #fff; }
        .state-tab#s-reg_bonus_established.active { background: #222; color: #fff; border: 1px solid #fff; }
        .workspace { display: flex; flex-direction: row-reverse; flex: 1; overflow: hidden; padding: 10px; gap: 10px; align-items: flex-start; justify-content: center; }
        .reel-container { width: 100px; height: 420px; position: relative; background: #000; border: 2px solid #333; border-radius: 4px; flex-shrink: 0; overflow: hidden; touch-action: none; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .reel-strip { position: absolute; width: 100%; top: 0; left: 0; will-change: transform; }
        .symbol { height: 60px; display: flex; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); position: relative; font-size: 10px; box-sizing: border-box; }
        .sym-idx { width: 26px; flex-shrink: 0; text-align: center; color: var(--c-accent); font-weight: bold; height: 100%; display: flex; align-items: center; justify-content: center; background: #111; border-right: 1px solid #333; z-index: 2; font-size: 11px; }
        .sym-bg { position: absolute; top: 0; left: 26px; right: 0; bottom: 0; z-index: 1; background-color: #000; background-repeat: no-repeat; background-position: center; }
        .target-box { position: absolute; top: 120px; left: 0; width: 100%; height: 180px; border: 3px solid #ff0000; pointer-events: none; z-index: 10; box-shadow: inset 0 0 10px rgba(255,0,0,0.2); }
        .results { flex: 1; height: 420px; background: #1a1a1a; border: 1px solid #333; overflow-y: auto; border-radius: 4px; display: flex; flex-direction: column; }
        .res-row { display: flex; border-bottom: 1px solid #333; min-height: 40px; align-items: center; padding: 0 8px; font-family: monospace; }
        .res-name { width: 90px; font-size: 11px; font-weight: bold; flex-shrink: 0; line-height: 1.2; }
        .res-data { flex: 1; text-align: right; font-size: 13px; color: #ddd; word-break: break-all; }
        .res-slip { display: inline-block; padding: 2px 6px; margin-left: 4px; background: #333; border-radius: 3px; font-weight: bold; color: #fff; min-width: 25px; text-align: center; }
        .res-row:nth-child(odd) { background: rgba(255,255,255,0.02); }
        .f-bell { border-left: 4px solid #ffeb3b; color: #ffeb3b; }
        .f-suika { border-left: 4px solid #00e676; color: #00e676; }
        .f-cher { border-left: 4px solid #ff4081; color: #ff4081; }
        .f-rep { border-left: 4px solid #80d8ff; color: #80d8ff; }
        .f-hazure { border-left: 4px solid #888; color: #aaa; }
        .f-tok { border-left: 4px solid #e040fb; color: #e040fb; }
        #error-log { display: none; position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); color:red; z-index:9999; padding:20px; white-space: pre-wrap; font-family:monospace; }
    </style>
</head>
<body>
    <div id="error-log"></div>
    <div class="controls">
        <div class="tab-group">
            <div id="t-left" class="stop-tab tab active" onclick="app.setStop('left')">左リール</div>
            <div id="t-middle" class="stop-tab tab" onclick="app.setStop('middle')">中リール</div>
            <div id="t-right" class="stop-tab tab" onclick="app.setStop('right')">右リール</div>
        </div>
        <div class="tab-group">
            <div id="s-bonus_unestablished" class="state-tab tab active" onclick="app.setState('bonus_unestablished')">ボーナス未成立</div>
            <div id="s-don_big_established" class="state-tab tab" onclick="app.setState('don_big_established')">ドンビッグ成立</div>
            <div id="s-seven_big_established" class="state-tab tab" onclick="app.setState('seven_big_established')">七ビッグ成立</div>
            <div id="s-reg_bonus_established" class="state-tab tab" onclick="app.setState('reg_bonus_established')">Regボーナス成立</div>
        </div>
    </div>
    <div class="workspace">
        <div id="touch-area" class="reel-container">
            <div class="target-box"></div>
            <div id="reel-strip" class="reel-strip"></div>
        </div>
        <div class="results" id="result-list"></div>
    </div>
<script>
const NAME_MAP = {
    "left": "left", "middle": "middle", "right": "right",
    "bonus_unestablished": "bonus_unestablished",
    "don_big_established": "don_big_established",
    "seven_big_established": "seven_big_established",
    "reg_bonus_established": "reg_bonus_established"
};
const REEL_ASSETS = { left: "reel1.png", middle: "reel2.png", right: "reel3.png" };
const FLAG_INFO = {
    hazure: { n: "ハズレ", c: "hazure" }, rep_normal: { n: "通常リプ", c: "rep" }, rep_jac: { n: "JACリプ", c: "rep" }, rep_rt: { n: "RTリプ", c: "rep" },
    bell_a: { n: "ベルA", c: "bell" }, bell_b: { n: "ベルB", c: "bell" }, sui_a: { n: "氷A", c: "suika" }, sui_b: { n: "氷B", c: "suika" },
    cher_a1: { n: "チェA1", c: "cher" }, cher_a2: { n: "チェA2", c: "cher" }, cher_b: { n: "チェB", c: "cher" },
    spec_a: { n: "特A", c: "tok" }, spec_b: { n: "特B", c: "tok" }, spec_c: { n: "特C", c: "tok" }, spec_d: { n: "特D", c: "tok" }, spec_e: { n: "特E", c: "tok" }
};
const REEL_SYMBOLS = {
    left: ["Rep","Cher","X","Bell","Sui","Rep","Bell","Sui","Seven","Bell","Rep","Cher","Bar","Bell","Sui","Rep","X","X","X","Sui","Bell"],
    middle: ["Bell","Cher","Rep","Bell","Cher","Sui","Seven","Sui","Bell","Bar","Cher","Rep","Bell","Cher","X","Rep","Bell","Cher","Sui","Cher","Rep"],
    right: ["Cher","Bell","Sui","Rep","Cher","Seven","Bell","Sui","Rep","Cher","Bell","Rep","Bar","Cher","Bell","Sui","Rep","X","Bell","Sui","Rep"]
};

class ReverseAuditor {
    constructor() { this.db = { left: {}, middle: {}, right: {} }; }
    register(reelName, stateName, rawText) {
        const reel = NAME_MAP[reelName];
        const state = NAME_MAP[stateName];
        if (!this.db[reel][state]) this.db[reel][state] = {};
        const flagOrder = ["hazure", "rep_normal", "rep_jac", "rep_rt", "bell_a", "bell_b", "sui_a", "sui_b", "cher_a1", "cher_a2", "cher_b", "spec_a", "spec_b", "spec_c", "spec_d", "spec_e"];
        flagOrder.forEach(f => this.db[reel][state][f] = new Array(22).fill(null));
        rawText.trim().split('\n').forEach(line => {
            const cols = line.trim().split(/\s+/);
            const rawPos = parseInt(cols[0], 10);
            // ★観測事実に基づく+1オフセット補正
            let pos = (rawPos % 21) + 1; 
            flagOrder.forEach((flag, idx) => {
                const val = cols[idx + 1];
                this.db[reel][state][flag][pos] = (val === "null" || val === undefined) ? null : parseInt(val, 10);
            });
        });
    }
    audit(reel, state, currentStopNum) {
        const table = this.db[reel][state];
        if (!table) return [];
        const flagOrder = ["hazure", "rep_normal", "rep_jac", "rep_rt", "bell_a", "bell_b", "sui_a", "sui_b", "cher_a1", "cher_a2", "cher_b", "spec_a", "spec_b", "spec_c", "spec_d", "spec_e"];
        return flagOrder.map(flagKey => {
            const slips = table[flagKey];
            const found = [];
            for (let P = 1; P <= 21; P++) {
                const L = slips[P];
                // 元の計算ロジックを維持
                if (L !== null && (P + L - 1) % 21 + 1 === currentStopNum) found.push({ pushNum: P, slip: L });
            }
            return { key: flagKey, info: FLAG_INFO[flagKey], matches: found.sort((a,b) => b.slip - a.slip || b.pushNum - a.pushNum) };
        }).filter(res => res.matches.length > 0);
    }
}
const Engine = new ReverseAuditor();
const parseAndRegister = (r, s, d) => Engine.register(r, s, d);

// 【データ注入】
parseAndRegister("left", "bonus_unestablished", `21 1 2 1 1 2 3 2 2 4 4 4 null null null null null\n20 0 0 2 0 3 4 0 0 1 1 1 null null null null null\n19 0 1 3 1 4 4 0 0 2 2 2 null null null null null\n18 1 1 0 1 0 0 2 2 3 3 3 null null null null null\n17 0 0 1 0 0 1 1 1 4 4 4 null null null null null\n16 2 1 2 1 1 2 3 3 0 0 0 null null null null null\n15 3 2 3 2 2 3 3 3 1 1 1 null null null null null\n14 3 3 1 3 3 4 4 4 0 0 2 null null null null null\n13 0 4 2 4 4 4 0 0 1 1 1 null null null null null\n12 1 0 3 0 0 1 1 1 2 2 4 null null null null null\n11 0 1 0 0 1 2 1 1 3 3 3 null null null null null\n10 1 0 1 1 2 3 2 2 4 4 4 null null null null null\n9 2 1 2 1 3 4 2 2 1 1 1 null null null null null\n8 0 2 0 2 4 0 3 3 2 2 2 null null null null null\n7 1 0 1 0 0 0 4 4 3 3 3 null null null null null\n6 2 1 2 1 2 1 1 1 0 0 0 null null null null null\n5 3 2 3 2 2 3 3 3 1 1 1 null null null null null\n4 4 3 1 3 3 4 3 3 0 0 2 null null null null null\n3 0 4 2 4 4 4 0 0 1 1 1 null null null null null\n2 1 0 3 0 0 0 0 0 2 2 4 null null null null null\n1 1 1 0 0 1 2 1 1 3 3 3 null null null null null`);
parseAndRegister("left", "don_big_established", `21 3 2 1 2 2 2 3 3 4 4 4 3 1 1 3 3\n20 4 0 2 0 3 4 4 4 1 1 1 4 0 2 4 4\n19 0 1 0 1 4 4 0 0 2 2 2 4 0 0 2 0\n18 1 1 1 1 0 0 2 2 3 3 3 1 1 1 2 1\n17 0 0 1 0 0 1 1 1 4 4 4 1 2 2 4 0\n16 2 1 3 1 1 1 3 3 0 0 0 1 3 2 3 2\n15 2 2 3 2 2 3 3 3 1 1 1 4 3 4 3 2\n14 3 3 4 3 3 4 4 4 0 0 2 4 4 4 3 3\n13 0 4 0 4 0 4 0 0 1 1 1 0 0 0 0 0\n12 1 0 0 0 0 1 1 1 2 2 4 1 1 1 1 1\n11 0 1 1 1 1 1 0 0 3 3 3 0 0 0 0 0\n10 1 0 2 0 3 2 1 1 4 4 4 1 1 1 0 1\n9 1 1 4 1 4 4 2 2 1 1 1 2 2 1 2 1\n8 1 2 0 2 0 0 3 3 2 2 2 3 2 1 1 1\n7 1 0 1 0 0 0 4 4 3 3 1 4 2 3 4 3\n6 1 1 2 1 1 1 1 1 0 0 0 2 4 3 3 3\n5 3 2 2 2 3 2 2 2 1 1 1 2 4 4 4 4\n4 3 3 4 3 3 3 3 3 0 0 0 4 4 3 4 3\n3 0 4 0 4 0 4 0 0 1 1 1 0 0 0 0 0\n2 1 0 1 0 0 0 1 1 2 2 2 1 1 1 1 1\n1 2 1 0 1 1 1 2 2 3 3 3 2 0 0 2 2`);
parseAndRegister("left", "seven_big_established", `21 1 2 0 2 2 3 2 2 4 4 4 2 1 1 1 1\n20 0 1 1 0 3 4 0 0 0 1 1 3 0 0 0 0\n19 0 0 1 1 4 4 0 0 1 2 2 0 0 1 0 0\n18 1 2 1 1 0 0 0 0 2 3 3 0 1 2 1 1\n17 1 0 0 0 0 1 1 1 3 4 4 0 2 1 0 0\n16 1 1 1 1 1 1 3 3 0 0 0 3 3 2 3 3\n15 4 2 0 2 2 2 3 3 1 1 1 2 3 3 3 3\n14 4 3 3 3 3 4 4 4 2 0 2 3 4 4 3 3\n13 4 4 4 4 4 0 0 0 1 1 1 0 4 0 4 0\n12 1 0 1 0 0 1 1 1 4 2 4 0 1 1 1 1\n11 2 1 4 1 1 2 1 1 3 3 3 1 0 2 0 2\n10 3 2 1 0 2 3 2 2 4 4 4 1 1 1 1 1\n9 4 1 1 1 3 4 2 2 2 1 1 2 2 2 2 2\n8 0 4 3 2 4 0 3 3 3 2 2 3 2 3 2 2\n7 0 0 0 0 0 0 4 4 4 3 3 4 2 3 2 2\n6 2 4 1 1 2 2 1 1 0 0 0 1 4 3 4 4\n5 2 2 0 2 2 2 2 2 1 1 1 3 4 4 4 4\n4 4 3 1 3 3 4 3 3 2 0 2 3 4 3 4 4\n3 0 4 4 4 4 0 0 0 1 1 1 0 0 0 0 0\n2 1 0 3 0 0 1 0 0 4 2 4 0 1 1 1 1\n1 0 1 4 1 1 2 1 1 3 3 3 1 0 0 0 0`);
parseAndRegister("left", "reg_bonus_established", `21 1 2 2 2 2 3 2 2 4 4 4 1 1 1 1 1\n20 0 1 0 0 3 4 0 0 1 1 1 0 0 0 2 0\n19 0 0 1 1 4 4 0 0 2 2 2 0 1 1 0 0\n18 1 2 1 1 0 0 0 0 3 3 3 0 2 2 1 1\n17 0 0 0 0 0 1 1 1 4 4 4 1 1 1 0 0\n16 3 1 1 1 1 1 3 3 0 0 0 2 2 2 2 3\n15 3 2 2 2 2 2 3 3 1 1 1 3 3 3 2 3\n14 3 3 3 3 3 4 4 4 0 0 0 4 4 4 3 3\n13 0 4 4 4 4 0 0 0 1 1 1 0 0 0 0 0\n12 1 0 0 0 0 1 1 1 2 2 2 1 1 1 1 1\n11 2 1 1 1 1 2 2 2 3 3 3 2 0 2 0 0\n10 3 2 0 0 2 3 3 3 4 4 4 3 1 1 1 1\n9 4 1 1 1 3 4 4 4 4 4 4 4 2 2 1 2\n8 2 4 2 2 4 0 3 3 2 2 2 3 3 3 1 3\n7 2 0 0 0 0 0 4 4 3 3 1 4 3 3 3 4\n6 2 4 1 1 2 2 1 1 0 0 0 3 3 3 3 4\n5 2 2 2 2 2 2 2 2 1 1 1 4 4 4 4 4\n4 4 3 3 3 3 4 3 3 0 0 2 3 3 3 3 4\n3 0 4 4 4 4 0 0 0 1 1 1 0 0 0 0 0\n2 1 0 0 0 0 1 0 0 2 2 4 1 1 1 1 1\n1 0 1 1 1 1 2 1 1 3 3 3 0 0 0 0 0`);
parseAndRegister("middle", "bonus_unestablished", `21 4 1 1 1 0 0 2 2 4 4 4 null null null null null\n20 0 2 2 2 1 1 3 3 0 0 0 null null null null null\n19 1 0 0 0 2 2 4 4 1 1 1 null null null null null\n18 2 1 1 1 0 0 2 2 2 2 2 null null null null null\n17 0 2 2 2 1 1 0 0 0 0 0 null null null null null\n16 1 3 3 3 2 2 0 0 1 1 1 null null null null null\n15 0 4 4 4 3 3 0 0 0 0 0 null null null null null\n14 1 0 0 0 4 4 2 2 1 1 1 null null null null null\n13 2 1 1 1 0 0 2 2 2 2 2 null null null null null\n12 3 2 2 2 1 1 4 4 3 3 3 null null null null null\n11 1 3 3 3 2 2 4 4 0 0 0 null null null null null\n10 1 0 0 0 3 3 2 2 1 1 1 null null null null null\n9 3 1 1 1 0 0 3 3 2 2 2 null null null null null\n8 0 2 2 2 1 1 0 0 3 3 3 null null null null null\n7 0 3 3 3 2 2 1 1 4 4 0 null null null null null\n6 1 0 0 0 3 3 2 2 2 2 1 null null null null null\n5 2 1 1 1 0 0 3 3 3 3 2 null null null null null\n4 3 2 2 2 1 1 0 0 0 0 3 null null null null null\n3 1 3 3 3 2 2 1 1 1 1 4 null null null null null\n2 2 4 4 4 3 3 0 0 2 2 2 null null null null null\n1 1 0 0 0 4 4 1 1 3 3 3 null null null null null`);
parseAndRegister("middle", "don_big_established", `21 2 1 1 1 0 0 2 2 4 4 4 4 2 2 2 4\n20 3 2 2 2 1 1 3 3 0 0 0 4 0 4 0 0\n19 0 0 0 0 2 2 4 4 1 1 1 4 1 4 1 1\n18 1 1 1 1 0 0 1 1 2 2 2 2 2 2 2 2\n17 2 2 2 2 1 1 0 0 0 0 0 3 3 3 3 0\n16 1 3 3 3 2 2 1 1 1 1 1 4 0 0 0 0\n15 1 4 4 4 3 3 1 1 0 0 0 0 0 0 0 0\n14 1 0 0 0 4 4 1 1 1 1 1 1 1 1 1 1\n13 3 1 1 1 0 0 3 3 2 2 2 2 2 2 2 2\n12 3 2 2 2 1 1 3 3 3 3 3 0 3 3 3 2\n11 0 3 3 3 2 2 4 4 0 0 0 0 4 4 4 4\n10 2 0 0 0 3 3 2 2 1 1 1 0 4 4 4 4\n9 2 1 1 1 0 0 2 2 2 2 2 1 0 0 2 1\n8 0 2 2 2 1 1 0 0 0 0 0 0 0 0 0 0\n7 0 3 3 3 2 2 0 0 0 0 0 0 1 1 0 0\n6 1 0 0 0 3 3 1 1 1 1 1 2 0 0 1 2\n5 1 1 1 1 0 0 1 1 3 3 3 3 1 1 2 3\n4 3 2 2 2 1 1 0 0 3 3 3 0 2 2 3 2\n3 3 3 3 3 2 2 1 1 4 4 4 0 3 3 4 4\n2 4 4 4 4 3 3 0 0 4 4 4 1 4 4 4 4\n1 1 0 0 0 4 4 1 1 3 3 3 3 1 1 1 3`);
parseAndRegister("middle", "seven_big_established", `21 4 1 1 1 0 0 4 4 4 4 4 2 2 2 2 2\n20 0 2 2 2 1 1 4 4 0 0 0 3 0 3 3 3\n19 1 0 0 0 2 2 4 4 1 1 1 4 1 4 0 0\n18 2 1 1 1 0 0 2 2 2 2 2 1 2 1 1 1\n17 3 2 2 2 1 1 0 0 0 0 0 2 3 2 2 0\n16 0 3 3 3 2 2 0 0 0 0 0 0 0 0 0 0\n15 0 4 4 4 3 3 0 0 0 0 0 1 0 1 1 1\n14 1 0 0 0 4 4 1 1 1 1 1 2 1 2 2 2\n13 2 1 1 1 0 0 2 2 2 2 2 3 2 3 3 3\n12 2 2 2 2 1 1 4 4 3 3 3 4 3 4 4 4\n11 4 3 3 3 2 2 4 4 4 4 4 4 4 4 4 4\n10 4 0 0 0 3 3 4 4 4 4 4 4 4 4 4 4\n9 1 1 1 1 0 0 1 1 2 2 2 0 0 0 0 0\n8 3 2 2 2 1 1 3 3 3 3 3 0 0 0 0 0\n7 4 3 3 3 2 2 4 4 4 4 4 1 1 1 1 1\n6 2 0 0 0 3 3 2 2 1 1 1 2 0 2 2 2\n5 3 1 1 1 0 0 3 3 3 3 3 3 1 3 3 3\n4 2 2 2 2 1 1 0 0 3 3 3 0 2 0 0 0\n3 0 3 3 3 2 2 0 0 1 1 1 1 3 1 1 1\n2 1 4 4 4 3 3 1 1 2 2 2 0 4 0 0 0\n1 3 0 0 0 4 4 3 3 3 3 3 1 1 1 1 1`);
parseAndRegister("middle", "reg_bonus_established", `21 2 1 1 1 0 0 2 2 4 4 4 2 2 2 2 2\n20 0 2 2 2 1 1 4 4 0 0 0 3 3 3 3 3\n19 1 0 0 0 2 2 4 4 1 1 1 4 4 4 4 4\n18 2 1 1 1 0 0 2 2 2 2 2 2 2 2 2 2\n17 3 2 2 2 1 1 0 0 0 0 0 3 3 3 3 0\n16 0 3 3 3 2 2 0 0 0 0 0 0 0 0 0 0\n15 0 4 4 4 3 3 0 0 0 0 0 0 0 0 0 0\n14 2 0 0 0 4 4 2 2 1 1 1 1 1 1 1 1\n13 2 1 1 1 0 0 2 2 2 2 2 2 2 2 2 2\n12 3 2 2 2 1 1 3 3 3 3 3 3 3 3 3 3\n11 0 3 3 3 2 2 4 4 0 0 0 4 4 4 4 4\n10 1 0 0 0 3 3 1 1 1 1 1 1 4 4 4 4\n9 2 1 1 1 0 0 2 2 2 2 2 2 0 0 2 2\n8 3 2 2 2 1 1 3 3 3 3 3 3 0 0 3 3\n7 4 3 3 3 2 2 4 4 4 4 4 4 1 1 4 4\n6 2 0 0 0 3 3 2 2 1 1 1 0 0 0 0 0\n5 3 1 1 1 0 0 3 3 3 3 3 1 1 1 1 1\n4 0 2 2 2 1 1 0 0 3 3 3 0 2 2 2 2\n3 3 3 3 3 2 2 1 1 4 4 4 1 3 3 3 3\n2 0 4 4 4 3 3 0 0 2 2 2 0 4 4 0 0\n1 1 0 0 0 4 4 1 1 3 3 3 3 3 3 3 3`);
parseAndRegister("right", "bonus_unestablished", `21 1 0 1 0 3 3 1 1 1 1 3 null null null null null\n20 1 1 2 1 0 0 2 2 2 2 0 null null null null null\n19 3 2 3 2 1 1 1 1 3 3 1 null null null null null\n18 3 3 0 3 2 2 0 0 0 0 2 null null null null null\n17 0 0 1 0 3 3 3 3 1 1 3 null null null null null\n16 1 1 2 1 0 0 2 2 2 2 0 null null null null null\n15 2 2 3 2 1 1 1 1 3 3 1 null null null null null\n14 3 3 0 3 2 2 0 0 0 0 2 null null null null null\n13 1 0 1 0 3 3 3 3 1 1 3 null null null null null\n12 2 1 2 1 4 4 2 2 2 2 4 null null null null null\n11 1 2 3 2 0 0 0 0 3 3 0 null null null null null\n10 4 3 4 3 1 1 4 4 4 4 1 null null null null null\n9 3 4 0 4 2 2 2 2 0 0 2 null null null null null\n8 0 0 1 0 3 3 1 1 1 1 3 null null null null null\n7 2 1 2 1 0 0 0 0 2 2 0 null null null null null\n6 2 2 3 2 1 1 3 3 3 3 1 null null null null null\n5 4 3 0 3 2 2 2 2 0 0 2 null null null null null\n4 0 0 1 0 3 3 1 1 1 1 3 null null null null null\n3 1 1 2 1 0 0 0 0 2 2 0 null null null null null\n2 2 2 3 2 1 1 3 3 3 3 1 null null null null null\n1 0 3 0 3 2 2 2 2 0 0 2 null null null null null`);
parseAndRegister("right", "don_big_established", `21 3 0 1 0 3 3 3 3 3 3 3 3 3 3 3 3\n20 4 1 2 1 0 0 4 4 4 4 4 4 4 4 4 4\n19 3 2 3 2 1 1 3 3 1 1 1 1 3 3 1 1\n18 2 3 0 3 2 2 2 2 0 0 0 0 0 0 0 0\n17 1 0 1 0 3 3 1 1 1 1 1 3 1 1 1 1\n16 0 1 2 1 0 0 0 0 2 2 2 2 2 2 0 2\n15 3 2 3 2 1 1 3 3 3 3 3 1 3 3 1 1\n14 2 3 0 3 2 2 2 2 0 0 0 4 2 2 2 4\n13 1 0 1 0 3 3 1 1 3 3 3 0 0 0 3 3\n12 4 1 2 1 4 4 4 4 2 2 2 1 1 1 4 1\n11 3 2 3 2 0 0 3 3 0 0 0 0 0 0 4 0\n10 1 3 4 3 1 1 1 1 4 4 4 3 1 1 4 3\n9 0 4 0 4 2 2 0 0 2 2 2 2 2 2 1 2\n8 3 0 1 0 3 3 3 3 1 1 1 3 3 3 1 3\n7 2 1 2 1 0 0 2 2 0 0 0 4 4 4 0 4\n6 1 2 3 2 1 1 1 1 1 1 1 1 3 3 1 1\n5 0 3 0 3 2 2 0 0 0 0 0 0 0 0 0 0\n4 1 0 1 0 3 3 1 1 1 1 1 1 1 1 1 1\n3 2 1 2 1 0 0 2 2 2 2 2 2 2 2 0 2\n2 1 2 3 2 1 1 1 1 3 3 3 1 3 3 1 1\n1 2 3 0 3 2 2 2 2 2 2 2 2 2 2 2 2`);
parseAndRegister("right", "seven_big_established", `21 1 0 1 0 3 3 1 1 1 1 1 3 1 3 3 3\n20 0 1 2 1 0 0 0 0 0 0 0 0 2 0 0 0\n19 1 2 3 2 1 1 1 1 3 3 3 0 3 0 0 0\n18 0 3 0 3 2 2 0 0 0 0 0 2 0 0 0 0\n17 3 0 1 0 3 3 3 3 3 3 3 3 1 1 1 1\n16 2 1 2 1 0 0 2 2 2 2 2 0 2 0 0 0\n15 1 2 3 2 1 1 1 1 1 1 1 1 3 1 1 1\n14 4 3 0 3 2 2 4 4 4 4 4 2 2 2 2 2\n13 0 0 1 0 3 3 3 3 0 0 0 0 0 0 3 0\n12 1 1 2 1 4 4 4 4 1 1 1 0 1 0 4 0\n11 0 2 3 2 0 0 0 0 0 0 0 0 0 0 0 0\n10 3 3 4 3 1 1 1 1 1 1 1 2 1 2 2 2\n9 2 4 0 4 2 2 2 2 2 2 2 2 2 2 2 2\n8 3 0 1 0 3 3 3 3 3 3 3 3 3 3 3 3\n7 4 1 2 1 0 0 4 4 4 4 4 4 4 4 4 4\n6 1 2 3 2 1 1 1 1 3 3 3 1 3 1 1 1\n5 2 3 0 3 2 2 2 2 2 2 2 2 0 2 2 2\n4 3 0 1 0 3 3 3 3 1 1 1 2 1 2 2 2\n3 2 1 2 1 0 0 2 2 2 2 2 0 2 0 0 0\n2 1 2 3 2 1 1 1 1 3 3 3 0 3 0 0 0\n1 2 3 0 3 2 2 2 2 0 0 0 1 0 1 1 1`);
parseAndRegister("right", "reg_bonus_established", `21 1 0 0 0 3 3 1 1 1 1 1 1 1 1 1 1\n20 0 1 1 1 0 0 0 0 0 0 0 0 0 0 0 0\n19 1 2 2 2 1 1 1 1 1 1 1 1 1 1 1 1\n18 0 3 3 3 2 2 0 0 0 0 0 0 0 0 0 0\n17 3 0 0 0 3 3 3 3 1 1 1 1 1 1 1 1\n16 2 1 1 1 0 0 2 2 2 2 2 2 2 2 2 2\n15 3 2 2 2 1 1 3 3 3 3 3 3 3 3 3 3\n14 4 3 3 3 2 2 4 4 4 4 4 4 4 4 4 4\n13 1 0 0 0 3 3 1 1 3 3 3 0 3 3 3 3\n12 2 1 1 1 4 4 2 2 2 2 2 0 4 4 4 4\n11 0 2 2 2 0 0 0 0 0 0 0 0 0 0 0 0\n10 4 3 3 3 1 1 4 4 4 4 4 1 1 1 1 1\n9 0 4 4 4 2 2 0 0 2 2 2 2 2 2 0 2\n8 1 0 0 0 3 3 1 1 1 1 1 3 3 3 1 3\n7 0 1 1 1 0 0 0 0 0 0 0 4 4 4 0 4\n6 1 2 2 2 1 1 1 1 1 1 1 1 1 1 1 1\n5 0 3 3 3 2 2 0 0 0 0 0 0 0 0 0 0\n4 3 0 0 0 3 3 3 3 3 3 3 1 1 1 1 1\n3 2 1 1 1 0 0 2 2 2 2 2 2 2 2 2 2\n2 3 2 2 2 1 1 3 3 3 3 3 3 3 3 3 3\n1 4 3 3 3 2 2 4 4 4 4 4 4 4 4 4 4`);

const app = {
    state: { reel: 'left', flagMode: 'bonus_unestablished', stopNum: 21 },
    init() { this.renderReelStrip(); this.attachEvents(); setTimeout(() => this.updateView(), 100); },
    setStop(side) { this.state.reel = side; document.querySelectorAll('.stop-tab').forEach(el => el.classList.toggle('active', el.id === `t-${this.state.reel}`)); this.renderReelStrip(); this.updateView(); },
    setState(mode) { this.state.flagMode = mode; document.querySelectorAll('.state-tab').forEach(el => el.classList.toggle('active', el.id === `s-${this.state.flagMode}`)); this.updateView(); },
    updateView() { this.audit(); this.updateReelPosition(); },
    audit() {
        const list = document.getElementById('result-list'); list.innerHTML = '';
        const results = Engine.audit(this.state.reel, this.state.flagMode, this.state.stopNum);
        if(results.length === 0) { list.innerHTML = '<div style="padding:20px; text-align:center; color:#555; font-size:12px;">条件に一致するフラグがありません</div>'; return; }
        results.forEach(res => {
            const row = document.createElement('div'); row.className = `res-row f-${res.info.c}`;
            row.innerHTML = `<div class="res-name">${res.info.n}</div><div class="res-data">${res.matches.map(m => `<span class="res-slip">[${m.slip}]</span>`).join('')}</div>`;
            list.appendChild(row);
        });
    },
    renderReelStrip() {
        const container = document.getElementById('reel-strip'); container.innerHTML = '';
        const symbols = REEL_SYMBOLS[this.state.reel]; const bgImage = REEL_ASSETS[this.state.reel]; 
        for(let loop=0; loop<3; loop++) {
            symbols.forEach((sym, idx) => {
                const reelNum = 21 - idx; const el = document.createElement('div'); el.className = 'symbol';
                el.innerHTML = `<div class="sym-idx">${reelNum}</div><div class="sym-bg" style="background-image: url('${bgImage}'); background-size: 100% ${21*60}px; background-position: center -${idx*60}px"></div>`;
                container.appendChild(el);
            });
        }
    },
    updateReelPosition() {
        const baseH = 21 * 60; const targetIdx = 21 - this.state.stopNum;
        const y = -baseH - (targetIdx * 60) + 120; // 元のターゲットボックス座標を維持
        document.getElementById('reel-strip').style.transform = `translate3d(0, ${y}px, 0)`;
    },
    attachEvents() {
        const touchArea = document.getElementById('touch-area');
        let startY = 0, startNum = 0, isDragging = false;
        const onMove = (y) => {
            if(!isDragging) return; const diff = startY - y; const moveFrame = Math.round(diff / 60);
            let nextNum = startNum - moveFrame; while(nextNum > 21) nextNum -= 21; while(nextNum < 1) nextNum += 21;
            if(this.state.stopNum !== nextNum) { this.state.stopNum = nextNum; this.updateView(); }
        };
        touchArea.addEventListener('mousedown', e => { isDragging=true; startY=e.pageY; startNum=this.state.stopNum; });
        window.addEventListener('mousemove', e => onMove(e.pageY)); window.addEventListener('mouseup', () => isDragging=false);
        touchArea.addEventListener('touchstart', e => { isDragging=true; startY=e.touches[0].pageY; startNum=this.state.stopNum; }, {passive:false});
        window.addEventListener('touchmove', e => { e.preventDefault(); onMove(e.touches[0].pageY); }, {passive:false});
        window.addEventListener('touchend', () => isDragging=false);
    }
};
app.init();
</script>
</body>
</html>